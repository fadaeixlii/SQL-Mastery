## 🛠️ STEP 3: DATA MANIPULATION LANGUAGE (DML)

---

### 🔹 What Is DML?

**DML (Data Manipulation Language)** is used to **interact with data** stored in database tables.

| Command  | Purpose                          |
| -------- | -------------------------------- |
| `INSERT` | Add new records                  |
| `UPDATE` | Modify existing records          |
| `DELETE` | Remove records                   |
| `SELECT` | Read records (covered in Step 4) |

---

## 🔸 1. `INSERT`

### ➕ Basic Insert

```sql
INSERT INTO users (name, email) VALUES ('Alice', 'alice@example.com');
```

> Adds a new row to the `users` table.

---

### ➕ Multiple Rows

```sql
INSERT INTO users (name, email)
VALUES
  ('Bob', 'bob@example.com'),
  ('Carol', 'carol@example.com');
```

---

### ➕ With DEFAULT Values

```sql
INSERT INTO products (name, price) VALUES ('Book', DEFAULT);
```

---

### ➕ `RETURNING` (PostgreSQL)

```sql
INSERT INTO users (name, email)
VALUES ('Dave', 'dave@example.com')
RETURNING id, created_at;
```

> Useful for getting autogenerated values right after insert.

---

## 🔸 2. `UPDATE`

### 🔁 Basic Update

```sql
UPDATE users SET name = 'Alice B.' WHERE id = 1;
```

> Changes the name of the user with `id = 1`.

---

### 🔁 Multiple Column Update

```sql
UPDATE products
SET stock = stock - 1, updated_at = NOW()
WHERE id = 'a123';
```

---

### 🔁 Conditional Update

```sql
UPDATE users
SET is_active = false
WHERE last_login < NOW() - INTERVAL '6 months';
```

---

## 🔸 3. `DELETE`

### ❌ Basic Delete

```sql
DELETE FROM users WHERE id = 3;
```

> Deletes the user with ID 3.

---

### ❌ Delete With Condition

```sql
DELETE FROM logs WHERE created_at < NOW() - INTERVAL '1 year';
```

---

### ❌ Dangerous: No `WHERE`!

```sql
DELETE FROM users;
```

> ⚠️ Deletes **ALL** users. Always use a `WHERE` clause unless intentional.

---

## 🔸 4. UPSERT (Insert or Update)

> Used to insert if record doesn’t exist, otherwise update it.

### 🔁 PostgreSQL `ON CONFLICT`

```sql
INSERT INTO users (id, email, name)
VALUES (1, 'admin@example.com', 'Admin')
ON CONFLICT (id)
DO UPDATE SET name = EXCLUDED.name;
```

---

### 🔁 MySQL / SQLite `INSERT ... ON DUPLICATE KEY UPDATE`

```sql
INSERT INTO users (id, email, name)
VALUES (1, 'admin@example.com', 'Admin')
ON DUPLICATE KEY UPDATE name = 'Admin';
```

---

## 🔸 5. Bulk Insert / Update / Delete Tips

| Tip                                        | Benefit                  |
| ------------------------------------------ | ------------------------ |
| Use transactions for multiple operations   | Prevent partial failures |
| Index columns used in `WHERE`              | Faster updates/deletes   |
| Use `RETURNING` for audit logs or ID reuse | Avoid extra select calls |

---

## ⚠️ Common DML Mistakes

| Mistake                                 | Why it's risky                          |
| --------------------------------------- | --------------------------------------- |
| Forgetting `WHERE` in `UPDATE`/`DELETE` | Affects all rows                        |
| No `RETURNING` when needing new IDs     | Requires another query                  |
| No `transaction` in multi-step ops      | Leaves DB in inconsistent state         |
| Blind trust on app-level validation     | Data integrity should be DB-guarded too |

---

## ✅ Best Practices

- Always use **parameterized queries** or ORM to avoid SQL injection.
- Wrap critical updates/deletes in **transactions**.
- Log or archive data before **deleting** (soft deletes are safer).
- Validate inputs at the DB layer (e.g., via `CHECK`, `NOT NULL`).

---

## 🧠 Real-World Example: Inventory Update

```sql
BEGIN;

UPDATE products
SET stock = stock - 3
WHERE id = 'prod-123' AND stock >= 3;

INSERT INTO order_items (order_id, product_id, quantity)
VALUES ('order-789', 'prod-123', 3);

COMMIT;
```

> Ensures that:
>
> - Inventory is updated only if enough stock
> - Items are only added to order if the update succeeds

---

## 🔜 Next Step

**Step 4: Querying with SELECT**

- Read data
- Filtering with `WHERE`
- Sorting with `ORDER BY`
- Grouping, aggregations, `DISTINCT`, and more
